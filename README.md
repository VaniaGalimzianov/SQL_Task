# Тестовое задание на должность Стажер разработчик MS SQL
* **Выполнил:** Галимзянов Иван
* **Дата выполнения:** 15.01.2025
* **Полный код процедуры:** [task.sql](https://github.com/VaniaGalimzianov/SQL_Task/blob/main/task.sql)

## Часть 1. Причины расхождений
**Задание:** заказчик утверждает, что продажи с НДС по сети, по группе товаров 'Биологически активные добавки', в июне 2017 составил 1 782 949.1 руб., продажи шт. - 6761.10. Необходимо найти и устранить возможные причины расхождений.

**Решение:** необходимо было изменить код процедуры `sp_report_1` и сравнить результат с данными заказчика. Поэтому были внесены некоторые изменения:

```sql
SUM(f.sale_net) AS [Общая стоимость товаров, с НДС],        
SUM(f.quantity) AS [Общее количество товаров]
```

**Результат:**

| Общая стоимость товаров, с НДС | Общее количество товаров |
|:-------------------------------|:-------------------------|
|  1679529.58                    | 6763.10                  |

**Пояснения:**
* Заказчик расчитывал стоимость товаров без учета НДС, то есть валовую стоимость
* Я изменил `f.sale_grs` на `f.sale_net`, чтобы расчитать продажи с НДС

## Часть 2. Добавление показателей
**Задание:** необходимо добавить показатели:
* Средняя цена закупки руб., без НДС
* Маржа руб., без НДС
* Наценка %, без НДС

**Решение:** требуемые показатели были расчитаны следующим образом:
* Средняя цена закупки руб., без НДС – общая стоимость закупки, деленная на общее количество проданных единиц
* Маржа руб. без НДС – разница между общей суммой продаж без НДС и стоимостью закупки товаров без НДС
* Наценка % без НДС – частное от маржы и общей стоимостью закупки, умноженное на 100%

```sql
SUM(f.cost_grs * f.quantity) / NULLIF(SUM(f.quantity), 0) AS [Средняя цена закупки руб., без НДС],
SUM(f.sale_grs * f.quantity) - SUM(f.cost_grs * f.quantity) AS [Маржа руб., без НДС],    
CASE     
  WHEN SUM(f.cost_grs * f.quantity) = 0 THEN NULL     
  ELSE ((SUM(f.sale_grs * f.quantity) - SUM(f.cost_grs * f.quantity)) / SUM(f.cost_grs * f.quantity)) * 100     
END AS [Наценка % без НДС]
```

**Результат:**

| Общая стоимость товаров, с НДС | Общее количество товаров | Средняя цена закупки руб., без НДС | Маржа руб., без НДС | Наценка %, без НДС
|:-------------------------------|:-------------------------|:-----------------------------------|:--------------------|:-----------------|
|  1679529.58                    | 6763.10                  | 474.0161                           | 892493.3086         | 27.83            |

**Пояснения:**
* В вычислениях показателей обработаны случаи, когда возможно деление на ноль

## Часть 3. Фильтрация по группам
**Задание**: Добавить возможность фильтрации по нескольким группам товаров одновременно. На вход группы подаются через запятую в параметр `@good_group_name`.

**Решение:** для разбиения строки по указанному разделителю в `SQL` есть встроенная функция `SPLIT_STRING`, однако при попытке ее использовать возникала ошибка `Invalid object name 'STRING_SPLIT'`, что говорит о том, что эта функция вероятно была отключена, поэтому была написана своя функция `SplitString`:

```sql
CREATE FUNCTION dbo.SplitString
(
    @List NVARCHAR(MAX),
    @Delimiter CHAR(1)
)
RETURNS @Result TABLE (Value NVARCHAR(MAX))
AS
BEGIN
    DECLARE @Start INT, @End INT
    SET @Start = 1
    SET @End = CHARINDEX(@Delimiter, @List)

    WHILE @Start <= LEN(@List)
    BEGIN
        IF @End = 0 
            SET @End = LEN(@List) + 1

        INSERT INTO @Result (Value)
        VALUES (SUBSTRING(@List, @Start, @End - @Start))

        SET @Start = @End + 1
        SET @End = CHARINDEX(@Delimiter, @List, @Start)
    END

    RETURN
END
```

Затем эта функция была использована в процедуре `sp_report_1`:

```sql
WHERE   
  f.date_id BETWEEN @date_from_int AND @date_to_int    
  AND g.group_name IN (SELECT Value FROM dbo.SplitString(@good_group_name, ','));    
```

При запуске процедуры были переданы две группы: _Биологически активные добавки, Косметические средства_:

```sql
EXEC sp_report_1
@date_from = '2017-06-01', 
@date_to = '2017-06-30', 
@good_group_name = N'Биологически активные добавки,Косметические средства'
```

**Результат:**
| Общая стоимость товаров, с НДС | Общее количество товаров | Средняя цена закупки руб., без НДС | Маржа руб., без НДС | Наценка %, без НДС
|:-------------------------------|:-------------------------|:-----------------------------------|:--------------------|:-----------------|
|  2905553.3157                  | 11176.6559               | 375.7478                           | 1441605.128         | 34.32            |

**Пояснения:**
* Функция `SplitString` принимает два параметра: `@List` и `@Delimeter`, затем определяются переменные `@Start` и `@End` обозначающие начальную позицию для извлечения подстроки и позицию первого вхождения разделителя в строке соответственно. Когда в цикле находится нужный элемент (разделитель), то происходит вставка подстроки (от `@Start` до `@End - @Start`) в таблицу результата `@Result`, после чего значения `@Start` и `@End` обновляются
* Однако данная функция может принимать разделитель, состоящий из одного символа, поэтому при передаче параметров после запятой не нужно ставить знак пробела

## Часть 4. Доля продаж с НДС товара
**Задание:** Вывести долю продаж с НДС товара, в каждом дне/магазине/группе товаров, отсортировать выборку по убыванию показателя.

**Решение:** для вычисления долю продаж с НДС товара продажи с НДС были поделены на их валовую стоимость, после чего из таблиц `dim_stores` и `dim_date` были получены названия аптек и даты соответственно. Затем с помощью `ORDER BY` выполнена группировка по доли продаж с НДС.

```sql
        CASE 
            WHEN gs.total_group_sales = 0 THEN 0 
            ELSE (SUM(f.sale_net * f.quantity) / gs.total_group_sales)
        END AS [Доля от продаж, с НДС %]
    FROM       
        [dbo].[fct_cheque] AS f        
    INNER JOIN       
        dim_goods AS g ON g.good_id = f.good_id        
    INNER JOIN       
        dbo.dim_stores AS s ON s.store_id = f.store_id
    INNER JOIN       
        dbo.dim_date AS d ON d.did = f.date_id
    LEFT JOIN 
        GroupSales gs ON gs.store_id = f.store_id AND gs.group_name = g.group_name AND gs.sale_date = d.d
    WHERE       
        f.date_id BETWEEN @date_from_int AND @date_to_int        
        AND g.group_name IN (SELECT Value FROM dbo.SplitString(@good_group_name, ','))        
    GROUP BY
        d.td,
        s.store_name,
        g.group_name,
        g.good_name,
        gs.total_group_sales
    ORDER BY 
        d.td ASC,
        [Доля от продаж, с НДС %] DESC;
END;
```

Также сформирован подзапрос для расчета суммы продаж с НДС в конкретной аптеке в определенный день:

```sql
 -- Подзапрос для расчета суммы продаж в конкретной аптеке
    WITH GroupSales AS (
        SELECT 
            f.store_id,
            g.group_name,
            d.d AS sale_date,
            SUM(f.sale_net * f.quantity) AS total_group_sales
        FROM       
            [dbo].[fct_cheque] AS f        
        INNER JOIN       
            dim_goods AS g ON g.good_id = f.good_id        
        INNER JOIN       
            dbo.dim_date AS d ON d.did = f.date_id
        WHERE       
            f.date_id BETWEEN @date_from_int AND @date_to_int        
            AND g.group_name IN (SELECT Value FROM dbo.SplitString(@good_group_name, ', '))
        GROUP BY 
            f.store_id,
            g.group_name,
            d.d
    )
```

**Результат:**
Весь результат представлен в файле [result.csv](https://github.com/VaniaGalimzianov/SQL_Task/blob/main/result.csv).

**Пояснения:**
* Получение значений названия аптек и даты проиходило с помощью `INNER JOIN` из таблиц `dim_stores` и `dim_date` по их `id`
* Добавлен расчет показателя _Доля продаж позиции в аптеке от продажи группы товара в этой же аптеке_
